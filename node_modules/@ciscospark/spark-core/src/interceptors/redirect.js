/**!
 *
 * Copyright (c) 2015 Cisco Systems, Inc. See LICENSE file.
 */

import {clone} from 'lodash';
import {Interceptor} from '@ciscospark/http-core';

const requestHeaderName = `cisco-no-http-redirect`;
const responseHeaderName = `cisco-location`;

export default class RedirectInterceptor extends Interceptor {
  constructor(spark) {
    super();

    if (!spark) {
      throw new Error(`\`spark\` is a required parameter`);
    }

    Reflect.defineProperty(this, `spark`, {
      enumerable: false,
      value: spark
    });
  }

  static create() {
    return new RedirectInterceptor(this);
  }

  onRequest(options) {
    if (options.uri.includes(this.spark.config.credentials.samlUrl) || options.uri.includes(this.spark.config.credentials.oauth.tokenUrl)) {
      return options;
    }

    options.headers[requestHeaderName] = true;
    options.$redirectCount = options.$redirectCount || 0;
    return options;
  }

  onResponse(options, response) {
    if (response.headers && response.headers[responseHeaderName]) {
      options = clone(options);
      options.uri = response.headers[responseHeaderName];
      options.$redirectCount += 1;
      if (options.$redirectCount > this.spark.config.maxAppLevelRedirects) {
        return Promise.reject(new Error(`Maximum redirects exceeded`));
      }

      return this.spark.request(options);
    }

    return response;
  }
}
