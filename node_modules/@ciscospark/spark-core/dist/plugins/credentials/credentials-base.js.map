{"version":3,"sources":["../../../src/plugins/credentials/credentials-base.js"],"names":[],"mappings":"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","file":"credentials-base.js","sourcesContent":["/**!\n *\n * Copyright (c) 2015 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport Authorization from './authorization';\nimport {base64, oneFlight, retry} from '@ciscospark/common';\nimport {clone, has, isObject, pick} from 'lodash';\nimport grantErrors from './grant-errors';\nimport querystring from 'querystring';\nimport SparkPlugin from '../../lib/spark-plugin';\n\n/**\n * Helper. Returns just the response body\n * @param {http.IncomingMessage} res\n * @returns {Object}\n */\nfunction resolveWithResponseBody(res) {\n  return res.body;\n}\n\n/**\n * Helper. Converts a response body into an Authorization object\n * @param {http.IncomingMessage} res\n * @returns {Authorization}\n */\nfunction processGrant(res) {\n  return new Authorization(res.body);\n}\n\nconst CredentialsBase = SparkPlugin.extend({\n  derived: {\n    canRefresh: {\n      deps: [`authorization.canRefresh`],\n      fn() {\n        // TODO also require client_id and client_secret be available\n        return !!(this.authorization && this.authorization.canRefresh);\n      }\n    },\n    isAuthenticated: {\n      deps: [`authorization.isAuthenticated`],\n      fn() {\n        return !!(this.authorization && this.authorization.isAuthenticated);\n      }\n    },\n    isAuthenticating: {\n      deps: [\n        `authorization.isRefreshing`,\n        `_isAuthenticating`\n      ],\n      fn() {\n        return this._isAuthenticating || (this.authorization && this.authorization.isRefreshing);\n      }\n    },\n    isExpired: {\n      deps: [`authorization.isExpired`],\n      fn() {\n        return !!(this.authorization && this.authorization.isExpired);\n      }\n    }\n  },\n\n  namespace: `Credentials`,\n\n  props: {\n    authorization: {\n      type: `state`\n    },\n    clientAuthorization: {\n      type: `state`\n    },\n    name: {\n      setOnce: true,\n      type: `string`\n    },\n    orgId: {\n      setOnce: true,\n      type: `string`\n    }\n  },\n\n  session: {\n    _isAuthenticating: {\n      default: false,\n      type: `boolean`\n    },\n    password: `string`,\n    previousAuthorization: {\n      type: `state`\n    }\n  },\n\n  authenticate(...args) {\n    return this.authorize(...args);\n  },\n\n  authorize: oneFlight(`authorize`, function authenticate(options) {\n    this._isAuthenticating = true;\n    options = options || {};\n    if (options.code) {\n      this.logger.info(`credentials: auth code received, exchanging for access_token`);\n      return this.requestAuthorizationCodeGrant(options)\n        .then((res) => {\n          this._isAuthenticating = false;\n          return res;\n        });\n    }\n\n    if (this.canRefresh) {\n      this.logger.info(`credentials: refreshable, refreshing`);\n      return this.refresh(options)\n        .then((res) => {\n          this._isAuthenticating = false;\n          return res;\n        });\n    }\n\n    this.set(pick(options, `name`, `orgId`, `password`));\n\n    if (this.name && this.orgId && this.password) {\n      this.logger.info(`credentials: machine credentials received, authenticating`);\n      return this.requestSamlExtensionGrant(options)\n        .then((res) => {\n          this._isAuthenticating = false;\n          return res;\n        })\n        .catch((res) => {\n          this._isAuthenticating = false;\n          return Promise.reject(res);\n        });\n    }\n\n    this._isAuthenticating = false;\n    return Promise.reject(new Error(`not enough parameters to authenticate`));\n  }),\n\n  getAuthorization: oneFlight(`getAuthorization`, function getAuthorization() {\n    if (this.isAuthenticated) {\n      if (this.isExpired) {\n        if (this.canRefresh) {\n          return this.refresh()\n            .then(() => {\n              return this.authorization.toString();\n            });\n        }\n\n        return Promise.reject(new Error(`Access token has expired or cannot be refreshed`));\n      }\n\n      return Promise.resolve(this.authorization.toString());\n    }\n\n    return Promise.reject(new Error(`not authenticated`));\n  }),\n\n  getClientAuthorization: oneFlight(`getClientCredentialsAuthorization`, function getClientCredentialsAuthorization() {\n    let promise;\n    if (!this.clientAuthorization || !this.clientAuthorization.isAuthenticated || this.clientAuthorization.isExpired) {\n      promise = this.requestClientCredentialsGrant();\n    }\n    else {\n      promise = Promise.resolve();\n    }\n\n    return promise\n      .then(() => {\n        return this.clientAuthorization.toString();\n      });\n  }),\n\n  /**\n   * @returns {Promise}\n   */\n  logout() {\n    return Promise.all([\n      `authorization`,\n      `previousAuthorization`\n    ].map((key) => {\n      if (this[key]) {\n        return this[key].revoke()\n          .catch((reason) => {\n            this.logger.error(`credentials: ${key} revocation falied`, reason);\n          });\n      }\n    }));\n  },\n\n  /**\n   * Refreshes credentials with a refresh token\n   * @param {Object} options\n   * @param {Object} options.force If true, refresh the token even if the token\n   * appears unexpired\n   * @returns {Promise} Resolves when credentials have been refreshed\n   */\n  refresh: oneFlight(`refresh`, function refresh(options) {\n    this.logger.info(`credentials: refresh requested`);\n\n    options = options || {};\n\n    if (!options.force && !this.authorization.isExpired) {\n      this.logger.info(`credentials: authorization not expired, not refreshing`);\n      return Promise.resolve();\n    }\n\n    this.logger.info(`credentials: refreshing`);\n\n    return this.authorization.refresh(options)\n      .then(this._pushAuthorization.bind(this))\n      .catch(this._handleRefreshFailure.bind(this));\n  }),\n\n  requestAuthorizationCodeGrant: oneFlight(`requestAuthorizationCodeGrant`, function requestAuthorizationCodeGrant(options) {\n    const vars = {\n      'oauth.client_id': `CLIENT_ID`,\n      'oauth.client_secret': `CLIENT_SECRET`,\n      'oauth.redirect_uri': `REDIRECT_URI`\n    };\n\n    for (const key in vars) {\n      if (!has(this.config, key)) {\n        const baseVar = vars[key];\n        return Promise.reject(new Error(`config.credentials.${key} or CISCOSPARK_${baseVar} or COMMON_IDENTITY_${baseVar} or ${baseVar} must be defined`));\n      }\n    }\n\n    /* eslint camelcase: [0] */\n    this.logger.info(`credentials: requesting authorization code grant`);\n\n    options = options || {};\n    options.scope = options.scope || this.config.oauth.scope;\n\n    if (!options.code) {\n      return Promise.reject(new Error(`\\`options.code\\` is required`));\n    }\n\n    return this.request({\n      method: `POST`,\n      uri: this.config.oauth.tokenUrl,\n      form: {\n        grant_type: `authorization_code`,\n        redirect_uri: this.config.oauth.redirect_uri,\n        code: options.code\n      },\n      auth: {\n        user: this.config.oauth.client_id,\n        pass: this.config.oauth.client_secret,\n        sendImmediately: true\n      },\n      shouldRefreshAccessToken: false\n    })\n      .then(processGrant)\n      .then(this._pushAuthorization.bind(this))\n      .catch((res) => {\n        if (res.statusCode !== 400) {\n          return Promise.reject(res);\n        }\n\n        const ErrorConstructor = grantErrors.select(res.body.error);\n        return Promise.reject(new ErrorConstructor(res._res || res));\n      });\n  }),\n\n  requestClientCredentialsGrant: oneFlight(`requestClientCredentialsGrant`, function requestClientCredentialsGrant(options) {\n    const vars = {\n      'oauth.client_id': `CLIENT_ID`,\n      'oauth.client_secret': `CLIENT_SECRET`\n    };\n\n    for (const key in vars) {\n      if (!has(this.config, key)) {\n        const baseVar = vars[key];\n        return Promise.reject(new Error(`config.credentials.${key} or CISCOSPARK_${baseVar} or COMMON_IDENTITY_${baseVar} or ${baseVar} must be defined`));\n      }\n    }\n\n    this.logger.info(`credentials: requesting client credentials grant`);\n\n    options = options || {};\n    // Right now, admin is the only service that needs Client Credentials,\n    // so we`ll hard code that here. long term, we`ll want to keep track of\n    // scope used to request a specific token and (potentially) specify\n    // scope as an options passed to Clinet#request so it can pick the right\n    // token.\n    options.scope = options.scope || `webexsquare:admin`;\n\n    return this.request({\n      method: `POST`,\n      uri: this.config.oauth.tokenUrl,\n      form: {\n        grant_type: `client_credentials`,\n        scope: options.scope,\n        shouldRefreshAccessToken: false\n      },\n      auth: {\n        user: this.config.oauth.client_id,\n        pass: this.config.oauth.client_secret,\n        sendImmediately: true\n      }\n    })\n      .then(processGrant)\n      .then(this._pushClientCredentialsAuthorization.bind(this))\n      .catch((res) => {\n        if (res.statusCode !== 400) {\n          return Promise.reject(res);\n        }\n\n        const ErrorConstructor = grantErrors.select(res.body.error);\n        return Promise.reject(new ErrorConstructor(res._res || res));\n      });\n  }),\n\n  requestSamlExtensionGrant: oneFlight(`requestSamlExtensionGrant`, retry(function requestSamlExtensionGrant(options) {\n    options = options || {};\n    options.scope = options.scope || this.config.oauth.scope;\n\n    this.logger.info(`credentials: requesting SAML extension grant`);\n\n    return this._getSamlBearerToken(options)\n      .then(this._getOauthBearerToken.bind(this, options))\n      .then(processGrant)\n      .then(this._pushAuthorization.bind(this))\n      .catch((res) => {\n        if (res.statusCode !== 400) {\n          return Promise.reject(res);\n        }\n\n        const ErrorConstructor = grantErrors.select(res.body.error);\n        return Promise.reject(new ErrorConstructor(res._res || res));\n      });\n  })),\n\n  set(key, value) {\n    let attrs;\n    if (isObject(key)) {\n      attrs = key;\n    }\n    else {\n      attrs = {};\n      attrs[key] = value;\n    }\n\n    [\n      `authorization`,\n      `clientAuthorization`,\n      `previousAuthorization`\n    ].forEach((key) => {\n      if (attrs[key]) {\n        if (!(attrs[key] instanceof Authorization)) {\n          attrs[key] = new Authorization(attrs[key]);\n        }\n        attrs[key].parent = this;\n      }\n    });\n\n    return Reflect.apply(SparkPlugin.prototype.set, this, arguments);\n  },\n\n  _buildLogoutUrl() {\n    // eslint doesn't yet handle nested strings quite right\n    /* eslint quotes: [0] */\n    return `${this.config.logoutUri}?${querystring.stringify({\n      type: 'logout',\n      goto: this.config.oauth.redirect_uri,\n      service: this.config.oauth.service\n    })}`;\n  },\n\n  _buildOAuthUrl: function _buildOAuthUrl(options) {\n    /* eslint camelcase: [0] */\n    const fields = [\n      `client_id`,\n      `redirect_uri`,\n      `scope`,\n      `service`\n    ];\n\n    const parameters = clone(options);\n\n    parameters.state = parameters.state || {};\n    if (!isObject(parameters.state)) {\n      return Promise.reject(new Error('if specified, `options.state` must be an object'));\n    }\n\n    if (!parameters.response_type) {\n      return Promise.reject(new Error('`options.response_type` is required'));\n    }\n\n    fields.forEach((key) => {\n      if (key in this.config.oauth) {\n        parameters[key] = this.config.oauth[key];\n      }\n      else {\n        // TODO figure out how to convert this to Promise.reject()\n        throw new Error(`\\`${key}\\` is required`);\n      }\n    }, this);\n\n    // Some browser aparently don't parse nested querystrings very well, so\n    // we'll additionally base64url-encode the state\n    parameters.state = base64.toBase64Url(querystring.stringify(parameters.state));\n    return `${this.config.oauth.authorizationUrl}?${querystring.stringify(parameters)}`;\n  },\n\n  /**\n   * Converts a CI SAML Bearer Token to an OAuth Bearer Token.\n   * @param {Object} options\n   * @param {Object} options.scope\n   * @param {Object} samlData Response body from the CI SAML endpoint.\n   * @private\n   * @return {Promise} Resolves with the bot's credentials.\n   */\n  _getOauthBearerToken: oneFlight(`_getOauthBearerToken`, function _getOauthBearerToken(options, samlData) {\n    this.logger.info(`credentials: exchanging SAML Bearer Token for OAuth Bearer Token`);\n\n    const vars = {\n      'oauth.client_id': `CLIENT_ID`,\n      'oauth.client_secret': `CLIENT_SECRET`\n    };\n\n    for (const key in vars) {\n      if (!has(this.config, key)) {\n        const baseVar = vars[key];\n        return Promise.reject(new Error(`config.credentials.${key} or CISCOSPARK_${baseVar} or COMMON_IDENTITY_${baseVar} or ${baseVar} must be defined`));\n      }\n    }\n\n    return this.request({\n      method: `POST`,\n      uri: this.config.oauth.tokenUrl,\n      form: {\n        /* eslint camelcase: [0] */\n        grant_type: `urn:ietf:params:oauth:grant-type:saml2-bearer`,\n        assertion: samlData.BearerToken,\n        scope: options.scope\n      },\n      auth: {\n        user: this.config.oauth.client_id,\n        pass: this.config.oauth.client_secret,\n        sendImmediately: true\n      },\n      shouldRefreshAccessToken: false\n    });\n  }),\n\n  /**\n   * Retrieves a CI SAML Bearer Token\n   * @private\n   * @return {Promise} Resolves with an Object containing a `BearerToken` and an\n   * `AccountExpires`\n   */\n  _getSamlBearerToken: oneFlight(`_getSamlBearerToken`, function _getSamlBearerToken() {\n    this.logger.info(`credentials: requesting SAML Bearer Token`);\n\n    if (!this.orgId) {\n      return Promise.reject(new Error(`\\`this.orgId\\` is required`));\n    }\n\n    if (!this.name) {\n      return Promise.reject(new Error(`\\`this.name\\` is required`));\n    }\n\n    if (!this.password) {\n      return Promise.reject(new Error(`\\`this.password\\` is required`));\n    }\n\n    return this.request({\n      method: `POST`,\n      uri: `{this.config.samlUrl}/{$this.orgId}/v2/actions/GetBearerToken/invoke`,\n      body: pick(this, `name`, `password`),\n      shouldRefreshAccessToken: false\n    })\n      // TODO consider handling a 401 error separately from other errors\n      .then(resolveWithResponseBody);\n  }),\n\n  _handleRefreshFailure: function _handleRefreshFailure(res) {\n    if (res.error && res.error === 'invalid_request') {\n      this.logger.warn('token refresh failed: ', res.errorDescription);\n      this.unset('authorization');\n    }\n\n    return Promise.reject(res);\n  },\n\n  _pushClientCredentialsAuthorization: function _pushClientCredentialsAuthorization(authorization) {\n    this.logger.info('credentials: received client credentials');\n\n    this.clientAuthorization = authorization;\n  },\n\n  _pushAuthorization: function _pushAuthorization(authorization) {\n    this.logger.info('credentials: received authorization');\n\n    const previousAuthorization = this.previousAuthorization;\n    this.previousAuthorization = this.authorization;\n    this.authorization = authorization;\n\n    if (previousAuthorization) {\n      previousAuthorization.revoke();\n    }\n  }\n\n});\n\nexport default CredentialsBase;\n"]}