/**!
 *
 * Copyright (c) 2015 Cisco Systems, Inc. See LICENSE file.
 */

import HttpError from '../http-error';
import Interceptor from '../lib/interceptor';

export default class HttpStatusInterceptor extends Interceptor {
  constructor(options) {
    super();

    const ErrorConstructor = options && (options.error || options.ErrorConstructor) || HttpError;

    Object.defineProperties(this, {
      ErrorConstructor: {
        value: ErrorConstructor
      }
    });
  }

  static create(options) {
    return new HttpStatusInterceptor(options);
  }

  onResponse(options, response) {
    if (response.statusCode && response.statusCode < 400) {
      return Promise.resolve(response);
    }

    // Note: the extra parenthesis below are required to make sure `new` is
    // applied to the correct method (i.e., the result of `select()`, not
    // `select()` itself).
    // TODO figure out how to get rid of `select` so that alternate
    // implementations don't need to supply it.
    return Promise.reject(new (this.ErrorConstructor.select(response.statusCode))(response));
  }
}
